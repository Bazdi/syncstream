// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String         @id @default(uuid())
  username           String         @unique
  email              String         @unique
  passwordHash       String
  avatarUrl          String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  ownedRooms         Room[]         @relation("RoomOwner")
  roomMemberships    RoomMember[]
  subscriptionStatus String         @default("free") // free, premium
  queueItems         QueueItem[]
}

model Room {
  id               String          @id @default(uuid())
  name             String
  ownerId          String
  owner            User            @relation("RoomOwner", fields: [ownerId], references: [id])
  currentVideoId   String?
  currentTimestamp Float           @default(0)
  isPlaying        Boolean         @default(false)
  tier             String          @default("free") // free, premium
  isPublic         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  queue            QueueItem[]
  members          RoomMember[]
  permissions      RoomPermissions?
}

model RoomMember {
  id        String   @id @default(uuid())
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("viewer") // owner, moderator, member, viewer
  joinedAt  DateTime @default(now())

  @@unique([roomId, userId])
}

model RoomPermissions {
  id                String   @id @default(uuid())
  roomId            String   @unique
  room              Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Playback controls
  canPlay           String   @default("everyone") // everyone, members, moderators, owner
  canPause          String   @default("everyone")
  canSeek           String   @default("everyone")
  canChangeVideo    String   @default("everyone")

  // Queue management
  canAddToQueue     String   @default("everyone")
  canRemoveFromQueue String  @default("members")
  canReorderQueue   String   @default("moderators")
  canClearQueue     String   @default("owner")

  // Room settings
  canInviteUsers    String   @default("members")
  canKickUsers      String   @default("moderators")
  canChangeSettings String   @default("owner")

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model QueueItem {
  id           String   @id @default(uuid())
  roomId       String
  room         Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  videoId      String
  videoTitle   String
  order        Int
  addedBy      String?
  addedByUser  User?    @relation(fields: [addedBy], references: [id], onDelete: SetNull)
  createdAt    DateTime @default(now())

  @@unique([roomId, order])
}
